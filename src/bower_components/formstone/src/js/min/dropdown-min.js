!function($,e,t){"use strict";function i(){F=e.$body}function o(t){t.multiple=this.prop("multiple"),t.disabled=this.is(":disabled"),t.multiple?t.links=!1:t.external&&(t.links=!0);var i=this.find(":selected").not(":disabled"),o=i.text(),l=this.find("option").index(i);t.multiple||""===t.label?t.label="":(i=this.prepend('<option value="" class="'+q.item_placeholder+'" selected>'+t.label+"</option>"),o=t.label,l=0);var s=this.find("option, optgroup"),n=s.filter("option");t.tabIndex=this[0].tabIndex,this[0].tabIndex=-1;var a=[q.base,t.customClass];t.mobile||e.isMobile?a.push(q.mobile):t.cover&&a.push(q.cover),t.multiple&&a.push(q.multiple),t.disabled&&a.push(q.disabled);var p='<div class="'+a.join(" ")+'" tabindex="'+t.tabIndex+'"></div>',c="";t.multiple||(c+='<button type="button" class="'+q.selected+'">',c+=$("<span></span>").text(y(o,t.trim)).html(),c+="</button>"),c+='<div class="'+q.options+'">',c+="</div>",this.wrap(p).after(c),t.$dropdown=this.parent(I.base),t.$allOptions=s,t.$options=n,t.$selected=t.$dropdown.find(I.selected),t.$wrapper=t.$dropdown.find(I.options),t.$placeholder=t.$dropdown.find(I.placeholder),t.index=-1,t.guid=G++,t.closed=!0,t.keyDownGUID=D.keyDown+t.guid,t.clickGUID=D.click+t.guid,d(t),t.multiple||x(l,t),t.$selected.touch({tap:!0}).on(D.tap,t,r),t.$dropdown.on(D.click,I.item,t,m).on(D.close,t,f),this.on(D.change,t,v),e.isMobile||(t.$dropdown.on(D.focus,t,b).on(D.blur,t,h),this.on(D.focus,t,function(e){e.data.$dropdown.trigger(D.raw.focus)}))}function l(e){e.$dropdown.hasClass(q.open)&&e.$selected.trigger(D.click),e.$el[0].tabIndex=e.tabIndex,e.$dropdown.off(D.namespace),e.$options.off(D.namespace),e.$placeholder.remove(),e.$selected.remove(),e.$wrapper.remove(),e.$el.off(D.namespace).show().unwrap()}function s(e,t){if("undefined"!=typeof t){var i=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(i).addClass(q.item_disabled),e.$options.eq(i).prop("disabled",!0)}else e.$dropdown.hasClass(q.open)&&e.$selected.trigger(D.click),e.$dropdown.addClass(q.disabled),e.$el.prop("disabled",!0),e.disabled=!0}function n(e,t){if("undefined"!=typeof t){var i=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(i).removeClass(q.item_disabled),e.$options.eq(i).prop("disabled",!1)}else e.$dropdown.removeClass(q.disabled),e.$el.prop("disabled",!1),e.disabled=!1}function a(e){var t=e.index;e.$allOptions=e.$el.find("option, optgroup"),e.$options=e.$allOptions.filter("option"),e.index=-1,t=e.$options.index(e.$options.filter(":selected")),d(e),e.multiple||x(t,e)}function d(e){for(var t="",i=0,o=0,l=e.$allOptions.length;l>o;o++){var s=e.$allOptions.eq(o),n=[];if("OPTGROUP"===s[0].tagName)n.push(q.group),s.is(":disabled")&&n.push(q.disabled),t+='<span class="'+n.join(" ")+'">'+s.attr("label")+"</span>";else{var a=s.val();s.attr("value")||s.attr("value",a),n.push(q.item),s.hasClass(q.item_placeholder)&&n.push(q.item_placeholder),s.is(":selected")&&n.push(q.item_selected),s.is(":disabled")&&n.push(q.item_disabled),t+='<button type="button" class="'+n.join(" ")+'" ',t+='data-value="'+a+'">',t+=$("<span></span>").text(y(s.text(),e.trim)).html(),t+="</button>",i++}}e.$items=e.$wrapper.html(t).find(I.item)}function r(t){U.killEvent(t);var i=t.data;if(!i.disabled)if(i.mobile||!e.isMobile||e.isFirefoxMobile)i.closed?p(i):c(i);else{var o=i.$el[0];if(j.createEvent){var l=j.createEvent("MouseEvents");l.initMouseEvent("mousedown",!1,!0,O,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(l)}else o.fireEvent&&o.fireEvent("onmousedown")}}function p(e){if(e.closed){$(I.base).not(e.$dropdown).trigger(D.close,[e]);var t=e.$dropdown.offset(),i=F.outerHeight(),o=e.$wrapper.outerHeight(!0),l=e.index>=0?e.$items.eq(e.index).position():{left:0,top:0};t.top+o>i&&e.$dropdown.addClass(q.bottom),F.on(e.clickGUID,":not("+I.options+")",e,u),e.$dropdown.addClass(q.open),g(e),e.closed=!1}}function c(e){e&&!e.closed&&(F.off(e.clickGUID),e.$dropdown.removeClass([q.open,q.bottom].join(" ")),e.closed=!0)}function u(e){U.killEvent(e);var t=e.data;t&&0===$(e.currentTarget).parents(I.base).length&&c(t)}function f(e){var t=e.data;t&&c(t)}function m(e){U.killEvent(e);var t=$(this),i=e.data;if(!i.disabled){if(i.$wrapper.is(":visible")){var o=i.$items.index(t);o!==i.index&&(x(o,i),C(i))}i.multiple||c(i)}}function v(e,t){var i=$(this),o=e.data;if(!t&&!o.multiple){var l=o.$options.index(o.$options.filter("[value='"+_(i.val())+"']"));x(l,o),C(o)}}function b(e){U.killEvent(e);var t=e.data;t.disabled||t.multiple||t.$dropdown.addClass(q.focus).on(t.keyDownGUID,t,w)}function h(e,t){U.killEvent(e);var i=e.data;i.$dropdown.removeClass(q.focus).off(i.keyDownGUID),i.multiple||c(i)}function w(t){var i=t.data;if(13===t.keyCode)i.closed||(c(i),x(i.index,i)),C(i);else if(!(9===t.keyCode||t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)){U.killEvent(t);var o=i.$items.length-1,l=i.index<0?0:i.index;if($.inArray(t.keyCode,e.isFirefox?[38,40,37,39]:[38,40])>-1)l+=38===t.keyCode||e.isFirefox&&37===t.keyCode?-1:1,0>l&&(l=0),l>o&&(l=o);else{var s=String.fromCharCode(t.keyCode).toUpperCase(),n,a;for(a=i.index+1;o>=a;a++)if(n=i.$options.eq(a).text().charAt(0).toUpperCase(),n===s){l=a;break}if(0>l||l===i.index)for(a=0;o>=a;a++)if(n=i.$options.eq(a).text().charAt(0).toUpperCase(),n===s){l=a;break}}l>=0&&(x(l,i),g(i))}}function x(e,t){var i=t.$items.eq(e),o=t.$options.eq(e),l=i.hasClass(q.item_selected),s=i.hasClass(q.item_disabled);if(!s)if(t.multiple)l?(o.prop("selected",null),i.removeClass(q.item_selected)):(o.prop("selected",!0),i.addClass(q.item_selected));else if(e>-1&&e<t.$items.length){var n=o.data("label")||i.html();t.$selected.html(n).removeClass(I.item_placeholder),t.$items.filter(I.item_selected).removeClass(q.item_selected),t.$el[0].selectedIndex=e,i.addClass(q.item_selected),t.index=e}else""!==t.label&&t.$selected.html(t.label)}function g(e){var t=e.$items.eq(e.index),i=e.index>=0&&!t.hasClass(I.item_placeholder)?t.position():{left:0,top:0};e.$wrapper.scrollTop(e.$wrapper.scrollTop()+i.top)}function C(e){e.links?k(e):e.$el.trigger(D.raw.change,[!0])}function k(e){var t=e.$el.val();e.external?O.open(t):O.location.href=t}function y(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}function _(e){return"string"==typeof e?e.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"):e}var E=e.Plugin("dropdown",{widget:!0,defaults:{cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,trim:0},methods:{_setup:i,_construct:o,_destruct:l,disable:s,enable:n,update:a,open:p,close:c},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{tap:"tap",close:"close"}}),I=E.classes,q=I.raw,D=E.events,U=E.functions,G=0,O=e.window,M=e.$window,j=e.document,F=null}(jQuery,Formstone);