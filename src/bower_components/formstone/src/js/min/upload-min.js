!function($,e,t){"use strict";function r(t){if(e.support.file){var r="";r+='<div class="'+v.target+'">',r+=t.label,r+="</div>",r+='<input class="'+v.input+'" type="file"',t.maxQueue>1&&(r+=" "+v.multiple),r+=">",this.addClass(v.base).append(r),t.$input=this.find(c.input),t.queue=[],t.total=0,t.uploading=!1,this.on(m.click,c.target,t,o).on(m.dragEnter,t,i).on(m.dragOver,t,l).on(m.dragLeave,t,u).on(m.drop,c.target,t,s),t.$input.on(m.change,t,n)}}function a(t){e.support.file&&(t.$input.off(m.namespace),this.off([m.click,m.dragEnter,m.dragOver,m.dragLeave,m.drop].join(" ")).removeClass(v.base).html(""))}function o(e){e.stopPropagation(),e.preventDefault();var t=e.data;t.$input.trigger(m.click)}function n(e){e.stopPropagation(),e.preventDefault();var t=e.data,r=t.$input[0].files;r.length&&p(t,r)}function i(e){e.stopPropagation(),e.preventDefault();var t=e.data;t.$el.addClass(v.dropping)}function l(e){e.stopPropagation(),e.preventDefault();var t=e.data;t.$el.addClass(v.dropping)}function u(e){e.stopPropagation(),e.preventDefault();var t=e.data;t.$el.removeClass(v.dropping)}function s(e){e.preventDefault();var t=e.data,r=e.originalEvent.dataTransfer.files;t.$el.removeClass(v.dropping),p(t,r)}function p(e,t){for(var r=[],a=0;a<t.length;a++){var o={index:e.total++,file:t[a],name:t[a].name,size:t[a].size,started:!1,complete:!1,error:!1,transfer:null};r.push(o),e.queue.push(o)}e.uploading||(q.on(m.beforeUnload,function(){return e.leave}),e.uploading=!0),e.$el.trigger(m.start,[r]),f(e)}function f(e){var t=0,r=[];for(var a in e.queue)!e.queue.hasOwnProperty(a)||e.queue[a].complete||e.queue[a].error||r.push(e.queue[a]);e.queue=r;for(var o in e.queue)if(e.queue.hasOwnProperty(o)){if(!e.queue[o].started){var n=new FormData;n.append(e.postKey,e.queue[o].file);for(var i in e.postData)e.postData.hasOwnProperty(i)&&n.append(i,e.postData[i]);d(e,e.queue[o],n)}if(t++,t>=e.maxQueue)return;a++}0===t&&(q.off(m.beforeUnload),e.uploading=!1,e.$el.trigger(m.complete))}function d(e,t,r){t.size>=e.maxSize?(t.error=!0,e.$el.trigger(m.fileError,[t,"Too large"]),f(e)):(t.started=!0,t.transfer=$.ajax({url:e.action,data:r,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var r=$.ajaxSettings.xhr();return r.upload&&r.upload.addEventListener("progress",function(r){var a=0,o=r.loaded||r.position,n=r.total;r.lengthComputable&&(a=Math.ceil(o/n*100)),e.$el.trigger(m.fileProgress,[t,a])},!1),r},beforeSend:function(r){e.$el.trigger(m.fileStart,[t])},success:function(r,a,o){t.complete=!0,e.$el.trigger(m.fileComplete,[t,r]),f(e)},error:function(r,a,o){t.error=!0,e.$el.trigger(m.fileError,[t,o]),f(e)}}))}var g=e.Plugin("upload",{widget:!0,defaults:{customClass:"",action:"",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,postData:{},postKey:"file"},classes:["input","target","multiple","dropping"],methods:{_construct:r,_destruct:a}}),c=g.classes,v=c.raw,m=g.events,h=g.functions,q=e.$window;m.complete="complete",m.fileStart="filestart",m.fileProgress="fileprogress",m.fileComplete="filecomplete",m.fileError="fileerror",m.start="start"}(jQuery,Formstone);