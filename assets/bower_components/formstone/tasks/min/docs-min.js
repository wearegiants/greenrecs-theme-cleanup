module.exports=function(e){e.registerTask("buildDocs","Build Formstone Docs.",function(){function n(e){var n={},t=e.split("\n"),i=["name","namespace","type","description","example","param","event","return","dependency"];for(var a in t){var s=t[a];for(var r in i){var o=i[r];if(s.indexOf("@"+o)>-1&&s.indexOf("@events")<0){var l=s.split("@"+o),p=l[l.length-1].trim();if(["param","event","return"].indexOf(o)>-1){var m=[];if("return"!==o?(m=p.split(" ",1),m.push(p.replace(m[0]+" ","")),p={name:m[0].trim()}):(m[0]="",m[1]=p,p={}),m[1]){var c=m[1].match(/\[([^\]]*)\]|\<([^\]]*)\>|\"([^\]]*)\"/g);for(var d in c){var f=c[d];0===f.indexOf("[")&&(p.type=f.replace("[","").replace("]","")),0===f.indexOf("<")&&(p["default"]=f.replace("<","").replace(">","")),0===f.indexOf('"')&&(p.description=f.replace(/"/g,""))}}}"param"===o?(n.params||(n.params=[]),n.params.push(p)):"event"===o?(n.events||(n.events=[]),n.events.push(p)):"dependency"===o?(n.dependencies||(n.dependencies=[]),n.dependencies.push(p)):n[o]=p}}}return n}function t(e){var n={},t=e.split("\n"),i=["name","description","type"];for(var a in t){var s=t[a];for(var r in i){var o=i[r];if(s.indexOf("@"+o)>-1){var l=s.split("@"+o),p=l[l.length-1].trim();n[o]=p}}}return n}function i(i){var a={main:[]},s=i,r=i.replace(/js/g,"less"),o=i.replace("src/js","src/docs").replace("src/less","src/docs").replace(/js/g,"md").replace(/less/g,"md"),l=i.replace("src/js","src/docs").replace("src/less","src/docs").replace(/js/g,"html").replace(/less/g,"html"),d=e.file.exists(s)?e.file.read(s):!1,f=e.file.exists(r)?e.file.read(r):!1,h=e.file.exists(o)?e.file.read(o):!1,v=e.file.exists(l)?e.file.read(l):!1,g;if(f&&(g=i.replace("src/less","docs/json").replace(".less",".json")),d&&r!==i&&(g=i.replace("src/js","docs/json").replace(".js",".json")),d){var u=d.match(/(?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)/g);if(a.options=[],a.events=[],a.methods=[],u)for(var y=0,b=u.length;b>y;y++){var w=u[y];if(w.indexOf("@plugin")>-1){var x=n(w);a.name=x.name,a.namespace=x.namespace,a.type=x.type,a.description=x.description,a.dependencies=x.dependencies}else if(w.indexOf("@options")>-1){var O=n(w);a.options=O.params}else if(w.indexOf("@events")>-1){var j=n(w);a.events=j.events}else if(w.indexOf("@method")>-1){a.methods||(a.methods=[]);var C=n(w);w.indexOf("private")<0&&(w.indexOf("@method widget")>-1?p.push(C):w.indexOf("@method utility")>-1?m.push(C):a.methods.push(C))}}var S=s.split("/"),D=S[S.length-1];a.main.indexOf(D)<0&&a.main.push(D)}if(f){var E=f.match(/(?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)/g);if(a.css=[],E)for(var y=0,b=E.length;b>y;y++){var w=E[y];if(w.indexOf("@class")>-1){var L=t(w);L.name&&a.css.push(L)}else if(w.indexOf("@grid")>-1){var _=t(w);a.name=_.name,a.namespace=_.namespace,a.type="grid",a.description=_.description}}var S=r.split("/"),D=S[S.length-1];a.main.indexOf(D)<0&&a.main.push(D.replace("less","css"))}if(a.name){var N=a.name.toLowerCase();if(d){if("formstone"!==N&&"core"!==N&&"grid"!==N){if("widget"===a.type)for(var y in p){var C=JSON.parse(JSON.stringify(p[y]));C.example=C.example.replace("{ns}",N),a.methods.push(C)}for(var y in m){var C=JSON.parse(JSON.stringify(m[y]));C.example=C.example.replace("{ns}",N),a.methods.push(C)}}a.methods.sort(function(e,n){return e.name<n.name?-1:e.name>n.name?1:0})}h&&(a.use=h),v&&(a.demo=v),e.file.write(g,JSON.stringify(a)),e.log.writeln('File "'+g+'" created.'),c[a.type]&&c[a.type].push(a)}}function a(e,n,t){var i=e.name.toLowerCase(),a="";if(a+=n+" "+e.name,a+="\n\n",a+=e.description,a+="\n\n",t&&e.demo&&(a+="* [Demo](#demo)",a+="\n"),a+="* [Use](#use)",a+="\n",e.options&&e.options.length&&(a+="* [Options](#options)",a+="\n"),e.events&&e.events.length&&(a+="* [Events](#events)",a+="\n"),e.methods&&e.methods.length&&(a+="* [Methods](#methods)",a+="\n"),e.css&&e.css.length&&(a+="* [CSS](#css)",a+="\n"),t&&(a+='<br class="split">\n'),a+="\n",a+=n+"# Use ",a+="\n\n",e.main&&e.main.length){a+=n+"### Main",a+="\n\n",a+="```markup",a+="\n";for(var s in e.main)a+=e.main[s],a+="\n";a+="```",a+="\n\n"}if(e.dependencies&&e.dependencies.length){a+=n+"### Dependencies",a+="\n\n",a+="```markup",a+="\n";for(var s in e.dependencies)a+=e.dependencies[s],a+="\n";a+="```",a+="\n\n"}if(e.use&&(a+=e.use,a+="\n\n"),e.options&&e.options.length){a+=n+"# Options",a+="\n\n","widget"===e.type&&(a+="Set instance options by passing a valid object at initialization, or to the public `defaults` method. Custom options for a specific instance can also be set by attaching a `data-"+i+"-options` attribute to the target elment. This attribute should contain the properly formatted JSON object representing the custom options."),"utility"===e.type&&(a+="Set instance options by passing a valid object at initialization, or to the public `defaults` method."),a+="\n\n",a+="| Name | Type | Default | Description |",a+="\n",a+="| --- | --- | --- | --- |",a+="\n";for(var s in e.options){var r=e.options[s];a+="| "+(r.name?"`"+r.name+"`":"&nbsp;"),a+=" | "+(r.type?"`"+r.type+"`":"&nbsp;"),a+=" | "+(r["default"]?"`"+r["default"]+"`":"&nbsp;"),a+=" | "+(r.description||"&nbsp;"),a+=" |\n"}a+="\n"}if(e.events&&e.events.length){a+=n+"# Events",a+="\n\n","widget"===e.type&&(a+="Events are triggered on the target instance's element, unless otherwise stated.",a+="\n\n"),"utility"===e.type&&(a+="Events are triggered on the `window`, unless otherwise stated.",a+="\n\n"),a+="| Event | Description |",a+="\n",a+="| --- | --- |",a+="\n";for(var s in e.events){var o=e.events[s];a+="| "+(o.name?"`"+o.name+"`":"&nbsp;"),a+=" | "+(o.description||"&nbsp;"),a+=" |\n"}a+="\n"}if(e.methods&&e.methods.length){a+=n+"# Methods",a+="\n\n","widget"===e.type&&(a+="Methods are publicly available to all active instances, unless otherwise stated.",a+="\n\n"),"utility"===e.type&&(a+="Methods are publicly available, unless otherwise stated.",a+="\n\n");for(var s in e.methods){var l=e.methods[s];if(a+=n+"## "+l.name,a+="\n\n",a+=l.description,a+="\n\n",l.example&&(a+="```javascript",a+="\n",a+=l.example,a+="\n",a+="```"),a+="\n\n",l.params&&l.params.length){a+=n+"### Parameters",a+="\n\n",a+="| Name | Type | Default | Description |",a+="\n",a+="| --- | --- | --- | --- |",a+="\n";for(var p in l.params){var m=l.params[p];a+="| "+(m.name?"`"+m.name+"`":"&nbsp;"),a+=" | "+(m.type?"`"+m.type+"`":"&nbsp;"),a+=" | "+(m["default"]?"`"+m["default"]+"`":"&nbsp;"),a+=" | "+(m.description||"&nbsp;"),a+=" |\n"}a+="\n"}}}if(e.css&&e.css.length){a+=n+"# CSS",a+="\n\n",a+="| Class | Type | Description |",a+="\n",a+="| --- | --- | --- |",a+="\n";for(var s in e.css){var c=e.css[s];a+="| "+(c.name?"`"+c.name+"`":"&nbsp;"),a+=" | "+(c.type?"`"+c.type+"`":"&nbsp;"),a+=" | "+(c.description||"&nbsp;"),a+=" |\n"}a+="\n"}return a}function s(n){var t=e.file.readJSON(n),i=n.replace("/json","").replace(".json",".md"),s=a(t,"#");e.file.write(i,s,!1),e.log.writeln('File "'+i+'" created.')}function r(n){var t=e.file.readJSON(n),i=n.replace("docs/json","demo/pages/components").replace(".json",".md"),s=i.replace("demo/pages/components","demo/templates/partials/components"),r=a(t,"#",!0),o=r.split('<br class="split">'),l={template:"component.html",title:t.name,demo:t.demo,bottom:"components/"+t.name.toLowerCase().replace(/ /g,""),site_root:"../",asset_root:"../../",component_root:"../../components/"};e.file.write(i,JSON.stringify(l)+"\n\n"+o[0]),e.file.write(s,o[1]),e.log.writeln('File "'+i+'" created.')}function o(){var n="";n+="## Library",n+="\n\n",n+="* [Core](core.md)",n+="\n";for(var t in c.grid){var i=c.grid[t];n+="* ["+i.name+"]("+i.name.toLowerCase().replace(/ /g,"")+".md)",n+="\n"}n+="\n",n+="## Utility",n+="\n\n";for(var t in c.utility){var i=c.utility[t];n+="* ["+i.name+"]("+i.name.toLowerCase().replace(/ /g,"")+".md)",n+="\n"}n+="\n",n+="## Widget",n+="\n\n";for(var t in c.widget){var i=c.widget[t];n+="* ["+i.name+"]("+i.name.toLowerCase().replace(/ /g,"")+".md)",n+="\n"}e.file.write("docs/README.md","# Documentation \n\n"+n)}function l(){var n="",t="";t+="<h5>About</h5>",t+="<ul>",t+='<li><a href="{{= it.site_root }}start.html">Getting Started</a></li>',t+='<li><a href="{{= it.site_root }}upgrade.html">Upgrade Guide</a></li>',t+='<li><a href="{{= it.site_root }}contribute.html">Contributing</a></li>',t+="</ul>",t+="<h5>Library</h5>",t+="<ul>",t+='<li><a href="{{= it.component_root }}core.html">Core</a></li>';for(var i in c.grid){var a=c.grid[i];t+='<li><a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a></li>"}t+="</ul>",t+="<h5>Utility</h5>",t+="<ul>";for(var i in c.utility){var a=c.utility[i];t+='<li><a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a></li>"}t+="</ul>",t+="<h5>Widget</h5>",t+="<ul>";for(var i in c.widget){var a=c.widget[i];t+='<li><a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a></li>"}t+="</ul>",e.file.write("demo/templates/partials/navigation.html",t),n+="<h2>Library</h2>",n+='<div class="listing">',n+='<a href="{{= it.component_root }}core.html">Core</a>';for(var i in c.grid){var a=c.grid[i];n+='<a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a>"}n+="</div>",n+="<h2>Utility</h2>",n+='<div class="listing">';for(var i in c.utility){var a=c.utility[i];n+='<a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a>"}n+="</div>",n+="<h2>Widget</h2>",n+='<div class="listing">';for(var i in c.widget){var a=c.widget[i];n+='<a href="{{= it.component_root }}'+a.name.toLowerCase().replace(/ /g,"")+'.html">'+a.name+"</a>"}n+="</div>",e.file.write("demo/templates/partials/component-list.html",n)}var p=[],m=[],c={grid:[],utility:[],widget:[]};e.file.expand("src/js/*.js").forEach(i),e.file.expand("src/less/*.less").forEach(i),e.file.expand("docs/json/*.json").forEach(s),e.file.expand("docs/json/*.json").forEach(r),o(),l();var d=e.file.readJSON("package.json"),f="README.md",h='<a href="http://gruntjs.com" target="_blank"><img src="https://cdn.gruntjs.com/builtwith.png" alt="Built with Grunt"></a> \n<a href="http://badge.fury.io/bo/formstone"><img src="https://badge.fury.io/bo/formstone.svg" alt="Bower version"></a> \n<a href="https://travis-ci.org/Formstone/Formstone"><img src="https://travis-ci.org/Formstone/Formstone.svg?branch=master" alt="Travis CI"></a> \n\n# '+d.name+" \n\n"+d.description+" \n\n[Documentation](docs/README.md)";e.file.write(f,h),e.log.writeln('File "'+f+'" created.')})};